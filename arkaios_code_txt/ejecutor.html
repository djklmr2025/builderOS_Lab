<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ARKAIOS Secure Account System</title>
  <style>
    :root {
      --primary: #6e48aa;
      --secondary: #9d50bb;
      --dark: #1e0033;
      --light: #f4f4f4;
      --ai: #00b09b;
      --human: #ec2F4B;
      --success: #28a745;
      --danger: #dc3545;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--dark), var(--primary));
      color: var(--light);
      min-height: 100vh;
      line-height: 1.6;
    }

    /* Contenedores principales */
    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }    
        
    .app-container {
      display: none;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Estilos de autenticaci√≥n */
    .auth-box {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 30px;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
    }
    
    .auth-box h1 {
      margin-bottom: 20px;
      color: white;
    }
    
    .auth-box input, .auth-box select {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      border: none;
      background: rgba(0, 0, 0, 0.3);
      color: white;
      font-size: 16px;
    }
    
    .auth-box button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    /* Estilos de la aplicaci√≥n */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      margin-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .logout-btn {
      background: var(--danger);
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
    }
    
    /* Estilos para m√≥dulos */
    .module-container {
      background: white;
      color: #333;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .module-title {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
      padding-bottom: 10px;
    }
    
    /* Estilos espec√≠ficos para cuentas */
    .account-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }
    
    .card-display {
      background: linear-gradient(135deg, #2b5876, #4e4376);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      font-family: 'Courier New', monospace;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .card-number {
      font-size: 1.2rem;
      letter-spacing: 2px;
      margin: 10px 0;
    }
    
    /* Botones */
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background-color: #4CAF50;
      color: white;
    }
    
    .btn-danger {
      background-color: #f44336;
      color: white;
    }
    
    .btn-info {
      background-color: #2196F3;
      color: white;
    }
    
    /* Visualizaci√≥n de datos */
    .data-viewer {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 15px;
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .json-viewer {
      font-family: 'Courier New', Courier, monospace;
      white-space: pre;
      font-size: 13px;
      line-height: 1.4;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    
    /* Mensajes de estado */
    .status {
      padding: 15px;
      margin: 20px 0;
      border-radius: 8px;
      text-align: center;
      display: none;
    }
    
    .status-success {
      background: rgba(40, 167, 69, 0.2);
      border: 1px solid var(--success);
    }
    
    .status-error {
      background: rgba(220, 53, 69, 0.2);
      border: 1px solid var(--danger);
    }
    
    /* Secciones de autenticaci√≥n */
    .auth-section {
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
    }
    
    .auth-section-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--light);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .account-form {
        grid-template-columns: 1fr;
      }
      
      .auth-box {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Pantalla de Autenticaci√≥n -->
  <div class="auth-container" id="authScreen">
    <div class="auth-box" id="loginBox">
      <div class="auth-logo">üîê ARKAIOS</div>
      <h1>Autenticaci√≥n Dual</h1>
      
      <!-- Secci√≥n Humano -->
      <div class="auth-section">
        <div class="auth-section-title">Autenticaci√≥n Humana</div>
        <input type="text" id="humanUsername" placeholder="Usuario Humano" value="ARKADMIN">
        <input type="password" id="humanPassword" placeholder="Contrase√±a" value="ARKAIOS2023">
        <input type="text" id="humanToken" placeholder="Token de Acceso" value="ARK-SECURE-TOKEN-2023">
      </div>
      
      <!-- Secci√≥n IA -->
      <div class="auth-section">
        <div class="auth-section-title">Autenticaci√≥n IA</div>
        <input type="text" id="aiKey" placeholder="Clave de Sistema IA" value="ARKAIOS-AI-KEY-2023!@#">
      </div>
      
      <!-- Carga de llave IA -->
      <div class="auth-section">
        <div class="auth-section-title">Archivo Llave (Bone.archivia)</div>
        <input type="file" id="keyFileInput" accept=".arkaios">
      </div>
      
      <button onclick="login()">Acceder al Sistema</button>
      <p id="loginMessage" style="color: var(--danger); margin-top: 10px; display: none;"></p>
    </div>
  </div>

  <!-- Aplicaci√≥n Principal -->
  <div class="app-container" id="appScreen">
    <header>
      <h1>ARKAIOS Secure Account System</h1>
      <div class="user-info">
        <span id="loggedUser">Administrador</span>
        <span class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</span>
      </div>
    </header>

    <div id="statusMessage" class="status"></div>

    <!-- M√≥dulo de Gesti√≥n de Cuentas -->
    <div class="module-container">
      <div class="module-title">üìù Gesti√≥n Segura de Cuentas</div>
      
      <div class="account-form">
        <div>
          <div class="form-group">
            <label>Nombre completo:</label>
            <input type="text" id="accountName">
          </div>
          
          <div class="form-group">
            <label>Alias de usuario:</label>
            <input type="text" id="accountUsername">
          </div>
          
          <div class="form-group">
            <label>Saldo inicial:</label>
            <input type="number" id="accountBalance">
          </div>
          
          <div class="card-display">
            <div>Tarjeta Asociada</div>
            <div class="card-number" id="accountCardNumber">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
            <div class="card-actions">
              <button class="btn btn-info" onclick="showCardDetails()">üîç Ver Detalles</button>
              <button class="btn btn-primary" onclick="generateNewCard()">üîÑ Generar Nueva</button>
            </div>
          </div>
          
          <button class="btn btn-primary" onclick="createAccount()">üíæ Crear Cuenta</button>
          <button class="btn btn-danger" onclick="clearForm()">üóëÔ∏è Limpiar Formulario</button>
        </div>
        
        <div>
          <div class="form-group">
            <label>Cargar cuenta segura (.arkaios):</label>
            <input type="file" id="accountFile" accept=".arkaios">
          </div>
          
          <div id="accountActions" style="display: none;">
            <button class="btn btn-primary" onclick="saveAccount()">üíæ Guardar Cambios</button>
            <button class="btn btn-info" onclick="closeAndSave()">üíæ Cerrar y Guardar</button>
          </div>
          
          <div class="data-viewer">
            <h3>Informaci√≥n de la Cuenta</h3>
            <div id="accountInfo"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- M√≥dulo de Transferencias (Ahora dentro del app-container) -->
    <div class="module-container" id="transferModule">
      <div class="module-title">üîÑ Transferencias ARKAIOS</div>
      <div class="account-form">
        <div>
          <div class="form-group">
            <label>Cuenta Origen:</label>
            <select id="transferOrigen" class="account-select">
              <option value="">Seleccionar cuenta</option>
            </select>
          </div>
          <div class="form-group">
            <label>Monto:</label>
            <input type="number" id="transferMonto" min="1" placeholder="Ej. 100">
          </div>
        </div>
        <div>
          <div class="form-group">
            <label>Destino (ID o QR):</label>
            <input type="text" id="transferDestino" placeholder="ID de cuenta o escanear QR">
            <button class="btn btn-info" onclick="escanearQR()">üì∑ Escanear QR</button>
          </div>
          <button class="btn btn-primary" onclick="iniciarTransferencia()">üí∏ Transferir</button>
        </div>
      </div>
      <div id="transferStatus" class="status"></div>
    </div>
  </div>

  <!-- Librer√≠a CryptoJS para cifrado -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <script>
    // =============================================
    // Sistema de Autenticaci√≥n Dual - Versi√≥n Mejorada
    // =============================================
    
    // Credenciales fijas
    const SYSTEM_CREDENTIALS = {
      human: {
        username: "ARKADMIN",
        password: "ARKAIOS2023",
        token: "ARK-SECURE-TOKEN-2023"
      },
      ai: {
        key: "ARKAIOS-AI-KEY-2023!@#"
      },
      keyFile: {
        required: true,
        nip: "72AB58"
      }
    };
    
    let currentUser = null;
    let currentAccount = null;
    let currentFile = null;
    let fileHandle = null;
    let cuentasCargadas = [];
    
    // Clave de cifrado fija
    const FIXED_ENCRYPTION_KEY = "ARKAIOS_SECURE_KEY_2023!@#";

    // Mostrar mensaje de estado
    function showStatus(message, type = 'success') {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.textContent = message;
      statusDiv.className = 'status status-' + type;
      statusDiv.style.display = 'block';
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }

    // Funci√≥n para validar el archivo de llave
    async function validateKeyFile(file) {
      return new Promise((resolve, reject) => {
        if (!SYSTEM_CREDENTIALS.keyFile.required) {
          resolve(true);
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            resolve(true);
          } catch (error) {
            reject(new Error('Error al validar archivo llave'));
          }
        };
        reader.onerror = () => reject(new Error('Error al leer archivo llave'));
        reader.readAsText(file);
      });
    }

    // Funci√≥n de login mejorada
    async function login() {
      const humanUsername = document.getElementById('humanUsername').value;
      const humanPassword = document.getElementById('humanPassword').value;
      const humanToken = document.getElementById('humanToken').value;
      const aiKey = document.getElementById('aiKey').value;
      const keyFileInput = document.getElementById('keyFileInput');
      const loginMessage = document.getElementById('loginMessage');

      // Validar campos b√°sicos
      if (!humanUsername || !humanPassword || !humanToken || !aiKey) {
        loginMessage.textContent = 'Todos los campos son requeridos';
        loginMessage.style.display = 'block';
        return;
      }

      // Validar archivo llave si es requerido
      if (SYSTEM_CREDENTIALS.keyFile.required) {
        if (!keyFileInput.files || keyFileInput.files.length === 0) {
          loginMessage.textContent = 'Debe cargar el archivo llave .arkaios';
          loginMessage.style.display = 'block';
          return;
        }

        const nip = prompt('Ingrese su NIP de administrador:');
        if (!nip || nip !== SYSTEM_CREDENTIALS.keyFile.nip) {
          loginMessage.textContent = 'NIP incorrecto o no proporcionado';
          loginMessage.style.display = 'block';
          return;
        }

        try {
          await validateKeyFile(keyFileInput.files[0]);
        } catch (error) {
          loginMessage.textContent = error.message;
          loginMessage.style.display = 'block';
          return;
        }
      }

      // Validar credenciales
      const humanAuth = (
        humanUsername === SYSTEM_CREDENTIALS.human.username &&
        humanPassword === SYSTEM_CREDENTIALS.human.password &&
        humanToken === SYSTEM_CREDENTIALS.human.token
      );
      
      const aiAuth = aiKey === SYSTEM_CREDENTIALS.ai.key;
      
      if (humanAuth && aiAuth) {
        // Login exitoso
        currentUser = {
          username: SYSTEM_CREDENTIALS.human.username,
          name: "Administrador del Sistema",
          role: "admin"
        };
        
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('appScreen').style.display = 'block';
        document.getElementById('loggedUser').textContent = currentUser.name;
        
        showStatus(`Autenticaci√≥n dual exitosa. Bienvenido, ${currentUser.name}`, 'success');
      } else {
        loginMessage.textContent = 'Credenciales incorrectas. Verifique los datos.';
        loginMessage.style.display = 'block';
      }
    }

    // Funci√≥n de logout
    function logout() {
      currentUser = null;
      currentAccount = null;
      currentFile = null;
      fileHandle = null;
      cuentasCargadas = [];
      document.getElementById('authScreen').style.display = 'flex';
      document.getElementById('appScreen').style.display = 'none';
      // Restaurar valores por defecto
      document.getElementById('humanUsername').value = SYSTEM_CREDENTIALS.human.username;
      document.getElementById('humanPassword').value = SYSTEM_CREDENTIALS.human.password;
      document.getElementById('humanToken').value = SYSTEM_CREDENTIALS.human.token;
      document.getElementById('aiKey').value = SYSTEM_CREDENTIALS.ai.key;
      document.getElementById('keyFileInput').value = '';
      document.getElementById('loginMessage').style.display = 'none';
      clearForm();
    }

    // =============================================
    // Sistema de Cuentas Seguras
    // =============================================
    
    // Generar n√∫mero de tarjeta
    function generateCardNumber() {
      let num = '';
      for (let i = 0; i < 16; i++) {
        num += Math.floor(Math.random() * 10);
        if ((i + 1) % 4 === 0 && i !== 15) num += ' ';
      }
      return num;
    }

    // Mostrar detalles de tarjeta
    function showCardDetails() {
      if (!currentAccount) {
        showStatus('No hay cuenta cargada', 'error');
        return;
      }
      
      if (!currentAccount.tarjeta) {
        showStatus('La cuenta no tiene tarjeta asociada', 'error');
        return;
      }
      
      alert(`Detalles de Tarjeta:\n\nTitular: ${currentAccount.nombre}\nN√∫mero: ${currentAccount.tarjeta}\nSaldo: $${currentAccount.saldo}`);
    }

    // Generar nueva tarjeta
    function generateNewCard() {
      if (!currentAccount) {
        currentAccount = {
          nombre: document.getElementById('accountName').value,
          usuario: document.getElementById('accountUsername').value,
          saldo: document.getElementById('accountBalance').value || 0,
          historial: []
        };
      }
      
      const newCard = generateCardNumber();
      currentAccount.tarjeta = newCard;
      document.getElementById('accountCardNumber').textContent = newCard;
      
      currentAccount.historial.unshift(`Nueva tarjeta generada: ${newCard} - ${new Date().toLocaleString()}`);
      
      showStatus('Nueva tarjeta generada', 'success');
    }

    // Limpiar formulario
    function clearForm() {
      document.getElementById('accountName').value = '';
      document.getElementById('accountUsername').value = '';
      document.getElementById('accountBalance').value = '';
      document.getElementById('accountCardNumber').textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
      document.getElementById('accountFile').value = '';
      document.getElementById('accountInfo').innerHTML = '';
      document.getElementById('accountActions').style.display = 'none';
      currentAccount = null;
      currentFile = null;
      fileHandle = null;
    }

    // Cifrar datos de cuenta
    function encryptAccountData(accountData) {
      try {
        const jsonData = JSON.stringify(accountData);
        const encrypted = CryptoJS.AES.encrypt(jsonData, FIXED_ENCRYPTION_KEY).toString();
        return encrypted;
      } catch (error) {
        showStatus('Error al cifrar cuenta: ' + error.message, 'error');
        return null;
      }
    }

    // Descifrar datos de cuenta
    function decryptAccountData(encryptedData) {
      try {
        const decryptedBytes = CryptoJS.AES.decrypt(encryptedData, FIXED_ENCRYPTION_KEY);
        const decrypted = decryptedBytes.toString(CryptoJS.enc.Utf8);
        
        if (!decrypted) {
          throw new Error('Archivo corrupto o no v√°lido');
        }
        
        return JSON.parse(decrypted);
      } catch (error) {
        showStatus('Error al descifrar cuenta: ' + error.message, 'error');
        return null;
      }
    }

    // Crear nueva cuenta
    function createAccount() {
      const nombre = document.getElementById('accountName').value;
      const usuario = document.getElementById('accountUsername').value;
      const saldo = parseFloat(document.getElementById('accountBalance').value) || 0;
      
      if (!nombre || !usuario) {
        showStatus('Nombre y usuario son obligatorios', 'error');
        return;
      }
      
      currentAccount = {
        id: `ARK-${Date.now().toString().slice(-6)}`,
        nombre,
        usuario,
        saldo,
        tarjeta: document.getElementById('accountCardNumber').textContent.replace(/\s/g, ''),
        historial: [`Cuenta creada: ${new Date().toLocaleString()}`],
        movimientos: [],
        metadata: {
          created: new Date().toISOString(),
          createdBy: currentUser.username
        }
      };
      
      // Agregar a cuentas cargadas
      cuentasCargadas.push(currentAccount);
      mostrarCuentasEnSelector();
      
      const encryptedAccount = encryptAccountData(currentAccount);
      if (!encryptedAccount) return;
      
      const blob = new Blob([encryptedAccount], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `${usuario}_${Date.now()}.arkaios`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      showStatus('Cuenta creada y cifrada correctamente', 'success');
      updateAccountInfo();
      document.getElementById('accountActions').style.display = 'block';
    }

    // Funci√≥n para guardar en archivo original
    async function saveToOriginal() {
      if (!fileHandle || !currentAccount) {
        console.log("No hay archivo original o cuenta cargada");
        return false;
      }
      
      try {
        const encryptedAccount = encryptAccountData(currentAccount);
        if (!encryptedAccount) return false;
        
        const writable = await fileHandle.createWritable();
        await writable.write(encryptedAccount);
        await writable.close();
        
        showStatus('Archivo original actualizado correctamente', 'success');
        return true;
      } catch (error) {
        console.error("Error al guardar:", error);
        showStatus(`Error al guardar: ${error.message}`, 'error');
        return false;
      }
    }

    // Cargar cuenta desde archivo
    document.getElementById('accountFile').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      currentFile = file;
      
      // Intentar obtener permisos de escritura si es posible
      if ('showOpenFilePicker' in window) {
        try {
          fileHandle = await window.showOpenFilePicker({
            types: [{
              description: 'ARKAIOS Account Files',
              accept: {'application/octet-stream': ['.arkaios']}
            }],
            multiple: false
          }).then(handles => handles[0]);
        } catch (error) {
          console.log("Modo solo lectura. Error al obtener permisos:", error);
          fileHandle = null;
        }
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const encryptedData = e.target.result;
          const decryptedAccount = decryptAccountData(encryptedData);
          
          if (decryptedAccount) {
            currentAccount = decryptedAccount;
            
            // Asegurar que tenga ID
            if (!currentAccount.id) {
              currentAccount.id = `ARK-${Date.now().toString().slice(-6)}`;
            }
            
            // Agregar a cuentas cargadas si no existe
            if (!cuentasCargadas.some(c => c.id === currentAccount.id)) {
              cuentasCargadas.push(currentAccount);
              mostrarCuentasEnSelector();
            }
            
            document.getElementById('accountName').value = currentAccount.nombre || '';
            document.getElementById('accountUsername').value = currentAccount.usuario || '';
            document.getElementById('accountBalance').value = currentAccount.saldo || 0;
            document.getElementById('accountCardNumber').textContent = 
              currentAccount.tarjeta ? formatCardNumber(currentAccount.tarjeta) : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            
            updateAccountInfo();
            document.getElementById('accountActions').style.display = 'block';
            
            showStatus('Cuenta cargada correctamente', 'success');
          }
        } catch (error) {
          showStatus('Error al cargar cuenta: ' + error.message, 'error');
        }
      };
      reader.readAsText(file);
    });

    // Formatear n√∫mero de tarjeta
    function formatCardNumber(number) {
      if (!number) return '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
      return number.toString().replace(/(\d{4})(?=\d)/g, '$1 ');
    }

    // Actualizar informaci√≥n de la cuenta
    function updateAccountInfo() {
      if (!currentAccount) return;
      
      let infoHtml = `
        <p><strong>ID:</strong> ${currentAccount.id}</p>
        <p><strong>Nombre:</strong> ${currentAccount.nombre}</p>
        <p><strong>Usuario:</strong> ${currentAccount.usuario}</p>
        <p><strong>Saldo:</strong> $${currentAccount.saldo || 0}</p>
        <p><strong>Tarjeta:</strong> ${formatCardNumber(currentAccount.tarjeta)}</p>
        <p><strong>Creada:</strong> ${new Date(currentAccount.metadata.created).toLocaleString()}</p>
      `;
      
      if (currentAccount.historial && currentAccount.historial.length > 0) {
        infoHtml += `<h4>Historial:</h4><ul>`;
        currentAccount.historial.slice(0, 5).forEach(item => {
          infoHtml += `<li>${item}</li>`;
        });
        infoHtml += `</ul>`;
      }
      
      document.getElementById('accountInfo').innerHTML = infoHtml;
    }

    // Guardar cambios en la cuenta actual
    function saveAccount() {
      if (!currentAccount) {
        showStatus('No hay cuenta cargada', 'error');
        return;
      }
      
      const nombre = document.getElementById('accountName').value;
      const usuario = document.getElementById('accountUsername').value;
      const saldo = parseFloat(document.getElementById('accountBalance').value) || 0;
      
      if (!nombre || !usuario) {
        showStatus('Nombre y usuario son obligatorios', 'error');
        return;
      }
      
      currentAccount.nombre = nombre;
      currentAccount.usuario = usuario;
      currentAccount.saldo = saldo;
      
      const cardDisplay = document.getElementById('accountCardNumber').textContent;
      if (cardDisplay !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
        currentAccount.tarjeta = cardDisplay.replace(/\s/g, '');
      }
      
      currentAccount.historial.unshift(`Cuenta actualizada: ${new Date().toLocaleString()}`);
      
      // Actualizar en cuentas cargadas
      const index = cuentasCargadas.findIndex(c => c.id === currentAccount.id);
      if (index !== -1) {
        cuentasCargadas[index] = currentAccount;
      }
      
      showStatus('Cambios guardados en la cuenta actual', 'success');
      updateAccountInfo();
    }

    async function closeAndSave() {
      if (await saveToOriginal()) {
        clearForm();
        showStatus('Cambios guardados y sesi√≥n cerrada', 'success');
      }
    }

    // =============================================
    // M√≥dulo de Transferencias
    // =============================================
    
    function mostrarCuentasEnSelector() {
      const select = document.getElementById('transferOrigen');
      select.innerHTML = '<option value="">Seleccionar cuenta</option>' + 
        cuentasCargadas.map(c => 
          `<option value="${c.id}">${c.nombre} ($${c.saldo})</option>`
        ).join('');
    }

    function escanearQR() {
      // Simulaci√≥n - En producci√≥n integrar con API de c√°mara
      showStatus('Modo QR activado. Usando cuenta demo: ARK-DEMO-002', 'info');
      document.getElementById('transferDestino').value = 'ARK-DEMO-002';
    }

    async function iniciarTransferencia() {
      const origenId = document.getElementById('transferOrigen').value;
      const destinoId = document.getElementById('transferDestino').value;
      const monto = parseFloat(document.getElementById('transferMonto').value);
      
      if (!origenId || !destinoId || !monto || isNaN(monto)) {
        showStatus('‚ùå Complete todos los campos correctamente', 'error');
        return;
      }

      try {
        const txId = await transferir(origenId, destinoId, monto);
        showStatus(`‚úÖ Transferencia ${txId} completada`, 'success');
        actualizarInfoCuentas();
      } catch (error) {
        showStatus(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function transferir(origenId, destinoId, monto) {
      const origen = cuentasCargadas.find(c => c.id === origenId);
      const destino = cuentasCargadas.find(c => c.id === destinoId);
      
      if (!origen) throw new Error("Cuenta origen no encontrada");
      if (!destino) throw new Error("Cuenta destino no encontrada");
      if (origen.saldo < monto) throw new Error("Saldo insuficiente");
      if (monto <= 0) throw new Error("Monto debe ser positivo");
      
      // Actualizar saldos
      origen.saldo -= monto;
      destino.saldo += monto;
      
      // Registrar movimiento
      const txId = `TX-${Date.now().toString().slice(-6)}`;
      const movimiento = {
        id: txId,
        fecha: new Date().toISOString(),
        monto: monto,
        origen: origenId,
        destino: destinoId,
        estado: "completado"
      };
      
      origen.movimientos = origen.movimientos || [];
      destino.movimientos = destino.movimientos || [];
      origen.movimientos.push(movimiento);
      destino.movimientos.push(movimiento);
      
      // Actualizar historial
      origen.historial = origen.historial || [];
      destino.historial = destino.historial || [];
      origen.historial.unshift(`Transferencia enviada: $${monto} a ${destinoId} - ${new Date().toLocaleString()}`);
      destino.historial.unshift(`Transferencia recibida: $${monto} de ${origenId} - ${new Date().toLocaleString()}`);
      
      // Guardar cambios
      if (origen === currentAccount || destino === currentAccount) {
        updateAccountInfo();
      }
      
      return txId;
    }

    function actualizarInfoCuentas() {
      mostrarCuentasEnSelector();
      if (currentAccount) updateAccountInfo();
    }
  </script>
</body>
</html>